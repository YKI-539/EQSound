<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Integrated Disaster Console</title>
    <style>
        :root {
            --bg-color: #05070a;
            --panel-bg: #1c2128;
            --accent-red: #ff3333;
            --accent-orange: #ff9900;
            --accent-yellow: #ffdd00;
            --accent-blue: #00ccff;
            --accent-green: #2ea043;
            --text-main: #adbac7;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; }
        h1 { text-align: center; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .panel { background: var(--panel-bg); border: 1px solid #444c56; border-radius: 10px; padding: 15px; }
        h2 { font-size: 1.1rem; margin-top: 0; border-bottom: 1px solid #444c56; padding-bottom: 8px; text-align: center; }
        
        .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 5px 8px; background: #22272e; border-radius: 4px; margin-bottom: 4px; font-size: 0.85rem; }
        input[type="file"] { width: 120px; font-size: 0.7rem; }
        
        .section-eew { border-top: 4px solid var(--accent-orange); }
        .section-tsunami { border-top: 4px solid var(--accent-blue); }
        .section-shindo { border-top: 4px solid #fff; }

        #monitor-btn { grid-column: 1 / -1; padding: 15px; font-size: 1.2rem; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; background: var(--accent-green); color: white; margin-top: 10px; }
        #monitor-btn:disabled { background: #373e47; color: #768390; }

        #log-panel { grid-column: 1 / -1; background: #000; border: 1px solid #444c56; border-radius: 8px; padding: 10px; height: 180px; overflow-y: auto; font-family: monospace; color: #00ff00; font-size: 0.85rem; margin-top: 15px; }
        .log-critical { color: var(--accent-red); font-weight: bold; background: rgba(255,0,0,0.1); }
        .log-warn { color: var(--accent-orange); }
        .log-info { color: var(--accent-blue); }
    </style>
</head>
<body>

<h1>ğŸš¨ Disaster Management Console</h1>

<div class="grid">
    <div class="panel section-eew">
        <h2 style="color: var(--accent-orange);">ç·Šæ€¥åœ°éœ‡é€Ÿå ± (EEW)</h2>
        <div class="setting-row"><span>äºˆå ± (Forecast)</span><input type="file" id="file-eew-f"></div>
        <div class="setting-row"><span>è­¦å ± (Warning)</span><input type="file" id="file-eew-w"></div>
    </div>

    <div class="panel section-tsunami">
        <h2 style="color: var(--accent-blue);">æ´¥æ³¢æƒ…å ±</h2>
        <div class="setting-row"><span>å¤§æ´¥æ³¢è­¦å ±</span><input type="file" id="file-tsunami-major"></div>
        <div class="setting-row"><span>æ´¥æ³¢è­¦å ±</span><input type="file" id="file-tsunami-warn"></div>
        <div class="setting-row"><span>æ´¥æ³¢æ³¨æ„å ±</span><input type="file" id="file-tsunami-adv"></div>
        <div class="setting-row"><span>æ´¥æ³¢äºˆå ±(è‹¥å¹²)</span><input type="file" id="file-tsunami-forecast"></div>
        <div class="setting-row"><span>è§£é™¤</span><input type="file" id="file-tsunami-clear"></div>
    </div>

    <div class="panel section-shindo">
        <h2>å„åœ°ã®éœ‡åº¦</h2>
        <div id="shindo-inputs"></div>
    </div>

    <button id="monitor-btn">ALL SYSTEMS ONLINE (éŸ³å£°æœ‰åŠ¹åŒ–)</button>
    <div id="log-panel">ã‚·ã‚¹ãƒ†ãƒ å¾…æ©Ÿä¸­...éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
</div>

<script>
    const audioStore = {};
    let lastIds = { eew: "", eq: "", tsunami: "" };

    // éœ‡åº¦UIç”Ÿæˆ
    const shindos = ["1", "2", "3", "4", "5å¼±", "5å¼·", "6å¼±", "6å¼·", "7"];
    shindos.forEach(s => {
        const row = document.createElement('div');
        row.className = 'setting-row';
        row.innerHTML = `<span>éœ‡åº¦${s}</span><input type="file" id="file-${s}">`;
        document.getElementById('shindo-inputs').appendChild(row);
        document.getElementById(`file-${s}`).addEventListener('change', (e) => saveFile(s, e));
    });

    // å„ç¨®ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    const fileMappings = {
        'file-eew-f': 'eew-f', 'file-eew-w': 'eew-w',
        'file-tsunami-major': 'MajorWarning', 'file-tsunami-warn': 'Warning',
        'file-tsunami-adv': 'Advisory', 'file-tsunami-forecast': 'Forecast', 'file-tsunami-clear': 'Clear'
    };
    Object.entries(fileMappings).forEach(([id, key]) => {
        document.getElementById(id).addEventListener('change', (e) => saveFile(key, e));
    });

    function saveFile(key, e) {
        const file = e.target.files[0];
        if (file) {
            if (audioStore[key]) URL.revokeObjectURL(audioStore[key]);
            audioStore[key] = URL.createObjectURL(file);
            addLog(`Ready: ${key}`);
        }
    }

    function addLog(msg, className = '') {
        const log = document.getElementById('log-panel');
        const div = document.createElement('div');
        div.className = className;
        div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.prepend(div);
    }

    function play(key) {
        if (audioStore[key]) new Audio(audioStore[key]).play();
        else addLog(`âš ï¸ éŸ³å£°æœªè¨­å®š: ${key}`, 'log-warn');
    }

    // --- API ç›£è¦– ---

    async function checkTsunami() {
        try {
            const res = await fetch('https://api.tdiys.jp/v1/tsunami');
            const data = await res.json();
            if (data && data.length > 0) {
                const latest = data[0];
                if (latest.id !== lastIds.tsunami) {
                    lastIds.tsunami = latest.id;
                    // è§£é™¤åˆ¤å®š
                    if (latest.cancelled) {
                        addLog("ã€æ´¥æ³¢æƒ…å ±ã€‘æ´¥æ³¢æ³¨æ„å ±ãƒ»è­¦å ±ã¯è§£é™¤ã•ã‚Œã¾ã—ãŸã€‚", "log-info");
                        play('Clear');
                        return;
                    }
                    // æœ€å¤§ç¨®åˆ¥åˆ¤å®š
                    const type = latest.maxGrade; // MajorWarning, Warning, Advisory, Forecast
                    addLog(`ã€æ´¥æ³¢ç™ºè¡¨ã€‘ç¨®é¡: ${type}`, "log-critical");
                    play(type);
                }
            }
        } catch (e) { console.error("Tsunami API Error", e); }
    }

    async function checkEEW() {
        try {
            const res = await fetch('https://api.tdiys.jp/v1/eew');
            const data = await res.json();
            if (data && data.length > 0) {
                const latest = data[0];
                const cid = `${latest.id}_${latest.serial}`;
                if (cid !== lastIds.eew) {
                    lastIds.eew = cid;
                    const type = latest.isWarning ? "eew-w" : "eew-f";
                    addLog(`ã€EEWã€‘ç¬¬${latest.serial}å ±: ${latest.hypocenter}`, latest.isWarning ? 'log-critical' : 'log-warn');
                    play(type);
                }
            }
        } catch (e) { }
    }

    async function checkEq() {
        try {
            const res = await fetch('https://api.tdiys.jp/v1/earthquake');
            const data = await res.json();
            if (data && data.length > 0) {
                const latest = data[0];
                if (latest.id !== lastIds.eq) {
                    lastIds.eq = latest.id;
                    const shindo = latest.maxIntensity.replace('5-', '5å¼±').replace('5+', '5å¼·').replace('6-', '6å¼±').replace('6+', '6å¼·');
                    addLog(`ã€éœ‡åº¦ã€‘${latest.hypocenter} éœ‡åº¦${shindo}`);
                    play(shindo);
                }
            }
        } catch (e) { }
    }

    document.getElementById('monitor-btn').addEventListener('click', function() {
        this.disabled = true;
        this.innerText = "MONITORING ACTIVE";
        addLog("â–¶ å…¨æ©Ÿèƒ½ã®ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
        setInterval(checkEEW, 2000);
        setInterval(checkTsunami, 5000);
        setInterval(checkEq, 5000);
    });
</script>
</body>
</html>
